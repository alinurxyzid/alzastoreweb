<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password - ALZA STORE</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    /* Font Inter */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Loading Spinner */
    #loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #2563eb;
      animation: spin 1s ease infinite;
    }
    .dark #loading-spinner {
      border-left-color: #3b82f6;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

  <div id="loading" class="fixed inset-0 z-[99] flex flex-col items-center justify-center bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm text-lg transition-opacity duration-300">
    <div id="loading-spinner"></div>
    <span id="loading-text" class="mt-3 font-semibold text-slate-700 dark:text-slate-300">Memverifikasi Link...</span>
  </div>

  <div class="min-h-screen flex flex-col items-center justify-center p-4">
    <img src="alza-logo.png" alt="Alza Store Logo" class="h-20 w-auto mb-6" onerror="this.src='https://placehold.co/200x80/e2e8f0/64748b?text=ALZA+STORE&font=inter'">
    
    <div class="max-w-md w-full bg-white dark:bg-slate-800 p-6 md:p-8 rounded-xl shadow-xl">
      <h2 class="text-2xl font-bold text-center mb-1 text-slate-800 dark:text-slate-200">
        Buat Password Baru
      </h2>
      <p class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6">
        Silakan masukkan password baru untuk akun Anda.
      </p>
      
      <form id="formUpdatePassword" class="space-y-4 hidden">
        <div>
          <label for="newPassword" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
            Password Baru
          </label>
          <div class="relative">
             <input id="newPassword" type="password" placeholder="Minimal 6 karakter"
                 class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10" 
                 required />
             <i id="toggle-password" class="fa-solid fa-eye-slash absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer"></i>
          </div>
        </div>
        <button type="submit" 
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-base shadow-md hover:bg-blue-700 transition-all duration-200 flex items-center justify-center gap-2">
          <i class="fa-solid fa-save"></i>
          Simpan Password Baru
        </button>
      </form>
      
      <div id="updateMessage" class="mt-4 text-center font-medium"></div>
    </div>
  </div>

  <script>
    // =============== [KONFIGURASI] ===============
    const SUPABASE_URL = 'https://pmxkyzgsauzxeidbjuhd.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBteGt5emdzYXV6eGVpZGJqdWhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjMwNDAsImV4cCI6MjA3NjY5OTA0MH0.oXlVN7F-CXN6zDCuOOr8u2N6efIo9GWd9JyJ5O0_fyA'; 
    // =============================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('formUpdatePassword');
    const message = document.getElementById('updateMessage');
    const loadingEl = document.getElementById('loading');
    const loadingText = document.getElementById('loading-text');
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('newPassword');

    // 1. Cek Dark Mode
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    // 2. Helper Functions
    function showLoading(text) {
      loadingText.textContent = text;
      loadingEl.classList.remove('hidden');
    }
    function hideLoading() { loadingEl.classList.add('hidden'); }
    
    function showMessage(text, isError = false) {
      message.innerHTML = text;
      message.className = isError 
        ? 'mt-4 text-center font-medium text-red-500 bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-200 dark:border-red-800' 
        : 'mt-4 text-center font-medium text-green-600 bg-green-50 dark:bg-green-900/20 p-2 rounded border border-green-200 dark:border-green-800';
    }

    // 3. Toggle Password Visibility
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye');
      togglePassword.classList.toggle('fa-eye-slash');
    });

    // 4. Handle Submit Form (Terpisah dari authStateChange)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPassword = passwordInput.value;
      
      if (newPassword.length < 6) {
        showMessage('Password minimal 6 karakter.', true);
        return;
      }

      showLoading('Menyimpan password baru...');
      
      const { data, error } = await supabase.auth.updateUser({
        password: newPassword
      });
      
      hideLoading();

      if (error) {
        showMessage(`<i class="fa-solid fa-circle-exclamation mr-1"></i> Gagal: ${error.message}`, true);
      } else {
        form.classList.add('hidden');
        showMessage(`<i class="fa-solid fa-check-circle mr-1"></i> Password berhasil diubah! <br>Mengalihkan ke halaman login...`, false);
        
        setTimeout(() => {
          window.location.href = 'login.html'; // Pastikan nama file login Anda benar
        }, 3000);
      }
    });

    // 5. Cek Auth State (Hanya untuk menampilkan Form)
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth Event:', event);

      if (event === 'PASSWORD_RECOVERY') {
        // Link Valid, User siap reset password
        hideLoading();
        form.classList.remove('hidden');
      
      } else if (event === 'SIGNED_IN' && window.location.hash.includes('type=recovery')) {
        // Fallback untuk beberapa kasus browser
        hideLoading();
        form.classList.remove('hidden');

      } else if (event === 'INITIAL_SESSION') {
        // Cek apakah ada error di URL hash (misal: link expired)
        const hash = window.location.hash.substring(1);
        const urlParams = new URLSearchParams(hash);
        const errorDesc = urlParams.get('error_description');
        const errorCode = urlParams.get('error_code');

        if (errorDesc) {
            hideLoading();
            let msg = 'Link tidak valid atau telah kedaluwarsa.';
            if (errorCode === 'otp_expired') msg = 'Link reset password sudah kedaluwarsa.';
            showMessage(msg + ' <br><a href="forgot-password.html" class="underline hover:text-blue-600">Minta link baru</a>', true);
        } else {
            // Jika tidak ada error tapi juga tidak masuk recovery mode
            // Tunggu sebentar, jika masih tidak ada session, mungkin user nyasar
            setTimeout(() => {
                if(form.classList.contains('hidden') && !message.textContent) {
                    hideLoading();
                    showMessage('Sesi tidak ditemukan. <a href="login.html" class="text-blue-500 underline">Kembali ke Login</a>', true);
                }
            }, 2000);
        }
      }
    });
  </script>
</body>
</html>